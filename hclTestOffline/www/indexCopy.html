<html>
<head>
<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script src="datajs-1.1.2.min.js"></script>

<script>
    var appId = "com.slb.plantoffline"; // Change this to app id on server
    var applicationContext = null;
    var smpServerProtocol = "http";
    var smpServerHost = "usphlvm1497.phl.sap.corp";
    var smpServerPort = "8081";
    var smpURL = smpServerProtocol + "://" + smpServerHost + ":" + smpServerPort;
    var odataSessionID = window.localStorage.getItem("odataSessionID");  //Unsure of the duration of the session.  Unregister and register to get a new session
    var authStr = null;
    var oDataVersion = "2";  //Note, the Offline OData plugin in SP05 only supports OData version 2.
    var store = null; //Offline OData store
    var startTime = null;
    var online = navigator.onLine;

    // Optional initial connection context
    var context = {
         "serverHost": smpServerHost, //Place your SMP 3.0 server name here
         "https": smpServerProtocol == "https",
         "serverPort": smpServerPort,
         "user": "I812441", //user name for registration and OData Endpoint
         "password": "Thewiseg10",  //password for registration and OData Endpoint
                               //once set can be changed by calling sap.Logon.changePassword()
         "communicatorId": "REST",
         "passcode": "password",  //note hardcoding passwords and unlock passcodes are strictly for ease of use during development
                                  //once set can be changed by calling sap.Logon.managePasscode()
         "unlockPasscode": "password",
         "passcode_CONFIRM":"password",
         "ssoPasscode":"Password1",
         /*"auth": [
                {
                    "type": "saml2.web.post",
                    "config": {
                        "saml2.web.post.authchallengeheader.name": "com.sap.cloud.security.login",
                        "saml2.web.post.finish.endpoint.uri": "/SAMLAuthLauncher",
                        "saml2.web.post.finish.endpoint.redirectparam": "finishEndpointParam"
                    }
                }
            ]*/
    };

    window.onerror = onError;

    function onError(msg, url, line) {
        var idx = url.lastIndexOf("/");
        var file = "unknown";
        if (idx > -1) {
            file = url.substring(idx + 1);
        }
        alert("An error occurred in " + file + " (at line # " + line + "): " + msg);
        return false; //suppressErrorAlert;
    }
    
    function init() {
        if (sap.Logger) {
            sap.Logger.setLogLevel(sap.Logger.DEBUG);  //enables the display of debug log messages from the Kapsel plugins.
            sap.Logger.debug("Log level set to DEBUG");
        }
        register()
        console.log("init completed");       
    }
    
    function register() {
        updateStatus2("register called");
        sap.Logon.init(logonSuccessCallback, logonErrorCallback, appId, context);
    }
    
    function logonSuccessCallback(result) {
        console.log("logonSuccessCallback " + JSON.stringify(result));
        updateStatus2("Successfully REGISTERED");
        applicationContext = result;
        //alternatively the authproxy plugin can provide this if SAPKapselHandleHttpRequests=true, (it is by default on iOS)
        authStr = "Basic " + btoa(applicationContext.registrationContext.user + ":" + applicationContext.registrationContext.password);
        console.log("user:" + applicationContext.registrationContext.user + "  pw:" + applicationContext.registrationContext.password);
    }

    function logonErrorCallback(error) {   //this method is called if the user cancels the registration.
        console.log("An error occurred:  " + JSON.stringify(error));
        if (device.platform == "Android") {  //Not supported on iOS
            navigator.app.exitApp();
        }
    }
    
    function unRegister() {
        updateStatus2("unregister called");
        sap.Logon.core.deleteRegistration(logonUnregisterSuccessCallback, errorCallback);
        clearTable("PlantsTable");
    }

    function logonUnregisterSuccessCallback(result) {
        updateStatus2("Successfully UNREGISTERED");
        console.log("logonUnregisterSuccessCallback " + JSON.stringify(result));
        applicationContext = null;
        odataSessionID = "";
        window.localStorage.setItem("odataSessionID", "");
    }    
        
    function errorCallback(e) {
        alert("An error occurred " + JSON.stringify(e));
        console.log("An error occurred " + JSON.stringify(e)); 
        updateStatus1("");
    }
    
    /*gga removed function getTempODataSession() {
        //Note that the (S(readwrite)) enables CUD operations see also http://services.odata.org/
        //Start with http://services.odata.org/V2/(S(readwrite))/OData/OData.svc/, when it is opened,
        //URL changes to something like http://services.odata.org/V2/(S(z0epoktenkvwyxp3hfnclx2c))/OData/OData.svc/
        if (!odataSessionID) {
            var xhr = new XMLHttpRequest();
            var aurl = smpURL + "/" + appId + "/V" + oDataVersion + "/(S(readwrite))/OData/OData.svc/"
            xhr.open("GET", aurl, false);
            //xhr.setRequestHeader("X-SMP-APPCID", applicationContext.applicationConnectionId);  //provided by the logon plugin
            xhr.setRequestHeader("Authorization", authStr);
            xhr.send();
    
            var result = /xml.base=\"(.*)\" xmlns:atom=/.exec(xhr.responseText);
            odataSessionID = result[1].substring("http://services.odata.org/".length, result[1].length - ("/V" + oDataVersion + "/OData/OData.svc/").length);
            window.localStorage.setItem("odataSessionID", odataSessionID);
        }
        //var str = smpURL + "/" + appId + "/V" + oDataVersion + "/" + odataSessionID + "/OData/OData.svc/";  //odd that in V2 the location of V2 is different in the xml:base vs URL
        //var str = smpURL + "/" + appId + "/" + getTempODataSession() + "/V" + oDataVersion + "/OData/OData.svc/";
        return odataSessionID;
    }*/
    
    function getEndPointURL() {
        //return smpURL + "/" + appId + "/" + getTempODataSession() + "/V" + oDataVersion + "/OData/OData.svc";
        return smpURL + "/com.slb.plantoffline/";
        //?$orderby=Name desc&milliseconds=" + new Date().getTime();
    }
 
    function read(isLocal) {
        updateStatus2("read request started");
        startTime = new Date();
        showScreen("MainDiv");
        clearTable("PlantsTable");
        
        if (!haveAppId()) {
            return;
        }
        
        var sURL = getEndPointURL() + "PlantSet";
        console.log("gga reading:" + sURL);
        if (isLocal) {  //displays entities that have been created or updated but have not yet been flushed.
            if (store && store.getRequestQueueStatus) { //filter is a new features in SP06 of the SDK.  getRequestQueueStatus was added in the same SP.  
                sURL = sURL + "&$filter=sap.islocal()";
            }
            else {
                alert("Displaying changed records that have not yet been flushed requires the offline store to be open and is a new feature in SP06 of the SDK"); 
            }
        } 
        var oHeaders = {};
        oHeaders['Authorization'] = authStr;
        //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;    //this header is provided by the logon plugin
        
        var request = {
            headers : oHeaders,
            requestUri : sURL,
            method : "GET"
        };
        console.log("read using " + sURL + "  with connection id: " + applicationContext.applicationConnectionId);
        OData.read(request, readSuccessCallback, errorCallback);
    }

    function readSuccessCallback(data, response) {
        var endTime = new Date();
        var duration = (endTime - startTime)/1000;
        updateStatus2("Read " + data.results.length + " records in " + duration + " seconds");
                
        var plantsTable = document.getElementById("PlantsTable");
        for (var i = 0; i < data.results.length; i++) {
            var row = plantsTable.insertRow(1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);
            cell1.innerHTML = '<input type="radio" name="ID" id="ID" value="' + data.results[i].ID + '">'; 
            cell2.innerHTML = data.results[i].Werks;
            cell3.innerHTML = data.results[i].Stand;
            cell4.innerHTML = data.results[i].Description;
        }
    }
    
    function deleteRecord() {
        if (!haveAppId()) {
            return;
        }
        //get the selected record to be deleted.
        var form = document.forms["PlantsForm"];
        var plantsRadioArray = form.ID;
        var radioEl = getSelectedRadioElement(plantsRadioArray);
        if (!radioEl) {
            alert("Please select a plant to be deleted");
            return;
        }
        var deleteProductsURL = getEndPointURL() + "/PlantSet(" + radioEl.value + ")";
        var oHeaders = {};
        oHeaders['Authorization'] = authStr;
        //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;    //this header is provided by the logon plugin
        
        var request = {
            headers : oHeaders,
            requestUri : deleteProductsURL,
            method : "DELETE"
        };
        OData.request(request, read, errorCallback);
    }
    
    function showUpdateDiv() {
        //get the selected record to be deleted.
        var plantsForm = document.forms["PlantsForm"];
        var plantsRadioArray = plantsForm.ID;
        var radioEl = getSelectedRadioElement(plantsRadioArray);
        if (!radioEl) {
            alert("Please select a plant to be updated");
            return;
        }
        var tr = radioEl.parentElement.parentElement;
        var id = radioEl.value;
        var updateForm = document.forms["UpdateForm"];
        updateForm.ID.value = id;
        var werks = tr.childNodes[1].innerHTML;
        updateForm.werks.value = werks;
        var stand = tr.childNodes[2].innerHTML;
        updateForm.stand.value = stand;
        var desc = tr.childNodes[3].innerHTML;
        updateForm.description.value = desc;
        
        
        showScreen("UpdateDiv");
    }
    
    function updateRecord() {
        var updateForm = document.forms["UpdateForm"];
        var updateProductsURL = getEndPointURL() + "/PlantSet(" + updateForm.ID.value + ")";
        var oHeaders = {};
        var params = {};
        params.Werks = updateForm.werks.value;
        params.Description = updateForm.description.value;
        params.Stand = updateForm.stand.value;
        oHeaders['Authorization'] = authStr;
        //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;    //this header is provided by the logon plugin
        
        var request = {
            headers : oHeaders,
            requestUri : updateProductsURL,
            method : "PUT",  //merge not supported for this OData producer
            data : params
        };
        OData.request(request, read, errorCallback);
    }
    
    function showCreateDiv() {
        if (!haveAppId()) {
            return;
        }
        var createForm = document.forms["CreateForm"];
        createForm.ID.value = "";
        createForm.werks.value = "";
        createForm.description.value = "";
        createForm.stand.value = "";
        showScreen("CreateDiv");
    }
    
    function createRecord() {
        var createForm = document.forms["CreateForm"];
        var oHeaders = {};
        var params = {};
        params.ID = createForm.ID.value;
        params.Werks = createForm.werks.value;
        params.Description = createForm.description.value;
        params.Stand = createForm.stand.value;
        oHeaders['Authorization'] = authStr;
        //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;    //this header is provided by the logon plugin
        
        var request = {
            headers : oHeaders,
            requestUri : getEndPointURL() + "/PlantSet",
            method : "POST",
            data : params
        };
        OData.request(request, read, errorCallback);
    }
    
    //returns the value of the checked radio element in the passed in array of radio elements 
    function getSelectedRadioElement(radioElementArray) {
        if (radioElementArray) {
            if (radioElementArray.length) {
                for (var i = 0; i < radioElementArray.length; i++) {
                    if (radioElementArray[i].checked) {
                        return radioElementArray[i]; 
                    }
                }
            }
            else {
                if (radioElementArray.checked) {
                        return radioElementArray; //just one row, radioElementArray is not an array in this case
                }
            }
        }
    }
    
    function showScreen(screenIDToShow) {
        var screenToShow = document.getElementById(screenIDToShow);
        screenToShow.style.display = "block";
        var screens = document.getElementsByClassName('screenDiv');
        for (var i = 0; i < screens.length; i++) {
            if (screens[i].id != screenToShow.id) {
                screens[i].style.display = "none";
            }
        }
    }

    function clearTable(tableId) {
        var plantsTable = document.getElementById(tableId);
        while(plantsTable.rows.length > 1) {
            plantsTable.deleteRow(1);
        }
    }

    function openStore() {
        if (!haveAppId()) {
            return;
        }
        startTime = new Date();
        updateStatus2("store.open called");
        var properties = {
            "name": "ProductsOfflineStore2",
            "host": applicationContext.registrationContext.serverHost,
            "port": applicationContext.registrationContext.serverPort,
            "https": applicationContext.registrationContext.https,
            "serviceRoot" : getEndPointURL(),
            
            "definingRequests" : {
                "PlantsDR2" : "/PlantSet"
            }
        };
            
        store = sap.OData.createOfflineStore(properties);
        store.onrequesterror = onRequestError; //called for each modification error during flush

        //var options = {};
        store.open(openStoreSuccessCallback, errorCallback/*, options*/);
    }
    
    function onRequestError(error) {
        alert("An error occurred while FLUSHING " + JSON.stringify(error));
    }

    function openStoreSuccessCallback() {
        var endTime = new Date();
        var duration = (endTime - startTime)/1000;
        updateStatus2("Store opened in  " + duration + " seconds");
        updateStatus1("Store is OPEN.");
        sap.OData.applyHttpClient();  //Offline OData calls can now be made against datajs.
    }

    function closeStore() {
        if (!store) {
            updateStatus2("The store must be opened before it can be closed");
            return;
        }
        updateStatus2("store.close called");
        store.close(closeStoreSuccessCallback, errorCallback);
    }
    
    function closeStoreSuccessCallback() {
        updateStatus1("Store is CLOSED.");
    }

    //Sends pending modification requests to the server.
    function flushStore() {
        if (!store) {
            updateStatus2("The store must be open before it can be flushed");
            return;
        }
        startTime = new Date();
        updateStatus2("store.flush called");
        store.flush(flushStoreSuccessCallback, errorCallback);
    }
    
    function flushStoreSuccessCallback() {
        var endTime = new Date();
        var duration = (endTime - startTime)/1000;
        updateStatus2("Store flushed in  " + duration + " seconds");
    }

    //After calling this the store will receive any changes from the OData producer.
    function refreshStore() {
        if (!store) {
            updateStatus2("The store must be open before it can be refreshed");
            return;
        }
        startTime = new Date();
        updateStatus2("store.refresh called");
        store.refresh(refreshStoreCallback, errorCallback);
    }
    
    function refreshStoreCallback() {
        var endTime = new Date();
        var duration = (endTime - startTime)/1000;
        updateStatus2("Store refreshed in  " + duration + " seconds");
    }

    //Removes the physical store from the filesystem
    function clearStore() {
        if (!store) {
            updateStatus2("The store must be closed before it can be cleared");
            return;
        }
        store.clear(clearStoreSuccessCallback, errorCallback);
    }
    
    function clearStoreSuccessCallback() {
        updateStatus1("");
        updateStatus2("Store is CLEARED");
        store = null; 
    }
    
    function showErrors() {
        if (!store) {
            updateStatus2("The store must be opened before viewing the ErrorArchive");
            return;
        }
        clearTable("ErrorsTable");
        showScreen("ErrorsDiv");
        updateStatus2("ErrorArchive request started");
        var sURL = getEndPointURL() + "/ErrorArchive";
        var oHeaders = {};
        oHeaders['Authorization'] = authStr;
        //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;    //this header is provided by the logon plugin
        
        var request = {
            headers : oHeaders,
            requestUri : sURL,
            method : "GET"
        };
        console.log("read using " + sURL);
        OData.read(request, showErrorsSuccessCallback, errorCallback);
    }

    function showErrorsSuccessCallback(data, response) {
        updateStatus2("ErrorArchive contains " + data.results.length + " records ");
        console.log(JSON.stringify(data.results));
        var plantsTable = document.getElementById("ErrorsTable");
        for (var i = 0; i < data.results.length; i++) {
            var row = plantsTable.insertRow(1);
            var plant = JSON.parse(data.results[i].RequestBody);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);
            var cell7 = row.insertCell(6);
            cell1.innerHTML = '<input type="radio" name="ID" id="ID" value="' + data.results[i].RequestID + '">'; 
            cell2.innerHTML = data.results[i].RequestMethod;
            cell3.innerHTML = plant.Werks;
            cell4.innerHTML = plant.Stand;
            cell5.innerHTML = plant.Description;
            cell6.innerHTML = data.results[i].RequestURL;
            cell7.innerHTML = data.results[i].Message;
        }
    }
    
    function clearError() {
        //get the selected record to be deleted.
        var form = document.forms["ErrorsForm"];
        var errorsRadioArray = form.ID;
        var radioEl = getSelectedRadioElement(errorsRadioArray);
        if (!radioEl) {
            alert("Please select an error to be cleared");
            return;
        }
        updateStatus2("Clear ErrorArchive entry started");
        var deleteErrorsURL = getEndPointURL() + "/ErrorArchive" + "(" + radioEl.value + ")";
        var oHeaders = {};
        oHeaders['Authorization'] = authStr;
        //oHeaders['X-SMP-APPCID'] = applicationContext.applicationConnectionId;    //this header is provided by the logon plugin
        
        var request = {
            headers : oHeaders,
            requestUri : deleteErrorsURL,
            method : "DELETE"
        };
        OData.request(request, showErrors, errorCallback);
    }

    function haveAppId() {
        if (!applicationContext) {
            alert("Please register with the SMP Server before proceeding");
            return false;
        }
        return true;
    }
    
    function getDeviceStatusString() {
        if (online) {
            return "Device is ONLINE";
        }
        else {
            return "Device is OFFLINE";
        }
    }
        
    function deviceOnline() {
        online = true;
        updateStatus1("");
    }
    
    function deviceOffline() {
        online = false;
        updateStatus1("");
    }
    
    function updateStatus1(msg) {
        document.getElementById('statusID').innerHTML = msg + " " + getDeviceStatusString();
        console.log(msg + " " + getDeviceStatusString());
    }
    
    function updateStatus2(msg) {
        var d = new Date();
        document.getElementById('statusID2').innerHTML = msg + " at " + addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + "." + addZero(d.getSeconds());
        console.log(msg + " at " + addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + "." + addZero(d.getSeconds()));
    }
    
    function addZero(input) {
        if (input < 10) {
            return "0" + input;
        }
        return input;
    }

    document.addEventListener("deviceready", init, false);
    document.addEventListener("online", deviceOnline, false);
    document.addEventListener("offline", deviceOffline, false);
</script>

</head>
<body onload="updateStatus1('');">
    <h1>Offline OData Sample 2</h1>
    <button id="register" onclick="register()">Register</button>
    <button id="unregister" onclick="unRegister()">Unregister</button><br>
    <button id="read" onclick="read()">Read</button>
    <button id="read2" onclick="read(true)">Read Local</button>
    <button id="create" onclick="showCreateDiv()">Create</button>
    <button id="update" onclick="showUpdateDiv();">Update</button>
    <button id="delete" onclick="deleteRecord()">Delete</button><br>
    <button id="openStore" onclick="openStore()">Open Store</button>
    <button id="closeStore" onclick="closeStore()">Close Store</button>
    <button id="flushStore" onclick="flushStore()">Flush Store</button>
    <button id="refreshStore" onclick="refreshStore()">Refresh Store</button>
    <button id="clearStore" onclick="clearStore()">Clear Store</button><br>
    <button id="showErrors" onclick="showErrors()">Check Errors</button>
    <button id="clearError" onclick="clearError()">Clear Error</button><br>
    <span id="statusID"></span><br>
    <span id="statusID2"></span>
    <div class="screenDiv" id="MainDiv">
        <form id="PlantsForm">
            <table id="PlantsTable"><tr><th></th><th>Werks</th><th>Stand</th><th>Description</th></tr></table>
        </form>
    </div>
    <div class="screenDiv" id="CreateDiv" style="display: none">
        <h3>Create</h3>
        <form id="CreateForm">
            ID: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" name="ID"><br>
            Werks: <input type="text" name="werks"><br>
            Stand: &nbsp;<input type="text" name="stand"><br>
            Desc: &nbsp;<input type="text" name="description" size="45"><br>
            <button id="update" type=button onclick="createRecord()">Create</button>
        </form>
    </div>
    <div class="screenDiv" id="UpdateDiv" style="display: none">
        <h3>Update</h3>
        <form id="UpdateForm">
            ID: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" name="ID" readonly><br>
            Werks: <input type="text" name="werks"><br>
            Desc: &nbsp;<input type="text" name="description" size="45"><br>
            Stand: &nbsp;<input type="text" name="stand"><br><br>
            
            <button id="update" type=button onclick="updateRecord()">Update</button>
        </form>
    </div>
    <div class="screenDiv" id="ErrorsDiv" style="display: none">
        <h3>Errors</h3>
        <form id="ErrorsForm">
            <table id="ErrorsTable"><tr><th><th>Operation</th><th>Plant</th><th>Stand</th><th>Description</th><th>Request URL</th><th>Message</th></tr></table>
        </form>
    </div>
</body>
</html>

